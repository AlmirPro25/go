╔════════════════════════════════════════════════════════════════════════════════╗
║                                                                                ║
║              🏗️ ARQUITETURA VISUAL: RAG ENTERPRISE GRADE 🏗️                  ║
║                                                                                ║
╚════════════════════════════════════════════════════════════════════════════════╝


┌─────────────────────────────────────────────────────────────────────────────┐
│                          FLUXO COMPLETO DO RAG                              │
└─────────────────────────────────────────────────────────────────────────────┘


                              🖥️ FRONTEND (React)
                              ─────────────────────
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
            ┌───────▼────────┐  ┌──▼──────────┐  ┌─▼──────────────┐
            │  Editor        │  │ Edge AI     │  │ Feedback Loop  │
            │  Colaborativo  │  │ (Gemini     │  │ (👍/👎)        │
            │  (TipTap)      │  │  Nano)      │  │                │
            │                │  │             │  │                │
            │ • Múltiplos    │  │ • Autocomplete  │ • Salva rating │
            │   cursores     │  │ • Correção  │  │ • Re-treina    │
            │ • Realtime     │  │   gramatical│  │   reranker     │
            │ • Offline      │  │ • < 100ms   │  │                │
            └────────┬───────┘  └──┬──────────┘  └─┬──────────────┘
                     │             │              │
                     └─────────────┼──────────────┘
                                   │
                    ┌──────────────▼──────────────┐
                    │   WebSocket (Socket.io)     │
                    │   Realtime Sync             │
                    └──────────────┬──────────────┘
                                   │
                                   │
                    ┌──────────────▼──────────────┐
                    │   🔴 PONTO 1: INDEXAÇÃO    │
                    │   ─────────────────────────│
                    │   Debounced Snapshot (30s) │
                    │   + Semantic Diff          │
                    │   + Cache Redis            │
                    └──────────────┬──────────────┘
                                   │
                    ┌──────────────▼──────────────┐
                    │   🔴 PONTO 3: SEGURANÇA    │
                    │   ─────────────────────────│
                    │   Input Guardrails         │
                    │   (Prompt Injection)       │
                    └──────────────┬──────────────┘
                                   │
                    ┌──────────────▼──────────────┐
                    │   🔴 PONTO 2: BUSCA HÍBRIDA│
                    │   ─────────────────────────│
                    │   BM25 (Keyword)           │
                    │   + Vector (Semântica)     │
                    │   + RRF (Fusion)           │
                    └──────────────┬──────────────┘
                                   │
                    ┌──────────────▼──────────────┐
                    │   🔴 PONTO 3: SEGURANÇA    │
                    │   ─────────────────────────│
                    │   Output Validation        │
                    │   (PII + Hallucination)    │
                    └──────────────┬──────────────┘
                                   │
                    ┌──────────────▼──────────────┐
                    │   🔴 PONTO 5: LLMOPS       │
                    │   ─────────────────────────│
                    │   RAGAS Evaluation         │
                    │   (Faithfulness, etc)      │
                    └──────────────┬──────────────┘
                                   │
                                   ▼
                    ┌──────────────────────────────┐
                    │   Resposta Segura & Auditada │
                    │   + Métricas de Qualidade    │
                    └──────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                        COMPONENTES DO BACKEND                               │
└─────────────────────────────────────────────────────────────────────────────┘


                          🔴 PONTO 1: INDEXAÇÃO
                          ────────────────────
                                  │
                    ┌─────────────┼─────────────┐
                    │             │             │
            ┌───────▼────────┐ ┌──▼──────────┐ │
            │ Debounce Timer │ │ Semantic    │ │
            │ (30s)          │ │ Diff Check  │ │
            │                │ │             │ │
            │ Cancela timer  │ │ Cosine      │ │
            │ anterior se    │ │ Similarity  │ │
            │ novo update    │ │ > 0.85?     │ │
            │ chegar        │ │             │ │
            └────────┬───────┘ └──┬──────────┘ │
                     │            │            │
                     └────────┬───┘            │
                              │               │
                    ┌─────────▼────────┐      │
                    │ Redis Cache      │      │
                    │ (embeddings)     │      │
                    │                  │      │
                    │ embedding:docId  │      │
                    │ TTL: 24h         │      │
                    └──────────────────┘      │
                                             │
                    ┌────────────────────────┘
                    │
                    ▼
            ┌──────────────────┐
            │ Chroma Vector DB │
            │ (HNSW Index)     │
            │                  │
            │ • documents      │
            │ • embeddings     │
            │ • metadata       │
            └──────────────────┘


                          🔴 PONTO 2: BUSCA HÍBRIDA
                          ────────────────────────
                                  │
                    ┌─────────────┼─────────────┐
                    │             │             │
            ┌───────▼────────┐ ┌──▼──────────┐
            │ Busca Vetorial │ │ Busca       │
            │ (Dense)        │ │ Keyword     │
            │                │ │ (Sparse)    │
            │ • Embedding    │ │             │
            │   da query     │ │ • BM25      │
            │ • HNSW search  │ │ • tsvector  │
            │ • Top-10       │ │ • PostgreSQL│
            │                │ │ • Top-10    │
            └────────┬───────┘ └──┬──────────┘
                     │            │
                     └────────┬───┘
                              │
                    ┌─────────▼────────┐
                    │ RRF (Fusion)     │
                    │                  │
                    │ score = 1/(k+r1) │
                    │       + 1/(k+r2) │
                    │                  │
                    │ k = 60           │
                    └────────┬─────────┘
                             │
                    ┌────────▼────────┐
                    │ Reranking       │
                    │ (Cross-Encoder) │
                    │                 │
                    │ Top-5 final     │
                    └─────────────────┘


                          🔴 PONTO 3: SEGURANÇA
                          ───────────────────
                                  │
                    ┌─────────────┼─────────────┐
                    │             │             │
            ┌───────▼────────┐ ┌──▼──────────┐ │
            │ Input Guard    │ │ Output      │ │
            │ rails          │ │ Validation  │ │
            │                │ │             │ │
            │ • Regex        │ │ • PII       │ │
            │   patterns     │ │   detection │ │
            │ • Injection    │ │ • CPF, email│ │
            │   detection    │ │ • Halluc.   │ │
            │ • 99% bloqueio │ │   check     │ │
            └────────┬───────┘ └──┬──────────┘ │
                     │            │            │
                     └────────┬───┘            │
                              │               │
                    ┌─────────▼────────┐      │
                    │ Audit Log        │      │
                    │ (PostgreSQL)     │      │
                    │                  │      │
                    │ • query          │      │
                    │ • response       │      │
                    │ • blocked?       │      │
                    │ • timestamp      │      │
                    └──────────────────┘      │
                                             │
                    ┌────────────────────────┘
                    │
                    ▼
            ┌──────────────────┐
            │ Resposta Segura  │
            │ (Sanitizada)     │
            └──────────────────┘


                          🔴 PONTO 4: EDGE AI
                          ─────────────────
                                  │
                    ┌─────────────┼─────────────┐
                    │             │             │
            ┌───────▼────────┐ ┌──▼──────────┐
            │ Gemini Nano    │ │ Fallback    │
            │ (Chrome 126+)  │ │ (WebLLM)    │
            │                │ │             │
            │ • Local        │ │ • Se Nano   │
            │ • < 100ms      │ │   indispon. │
            │ • Zero custo   │ │ • Mesmo     │
            │ • Privacidade  │ │   resultado │
            │ • Offline      │ │             │
            └────────┬───────┘ └──┬──────────┘
                     │            │
                     └────────┬───┘
                              │
                    ┌─────────▼────────┐
                    │ Sugestões Locais │
                    │                  │
                    │ • Autocomplete   │
                    │ • Correção       │
                    │ • Sumarização    │
                    └──────────────────┘


                          🔴 PONTO 5: LLMOPS
                          ────────────────
                                  │
                    ┌─────────────┼─────────────┐
                    │             │             │
            ┌───────▼────────┐ ┌──▼──────────┐ │
            │ RAGAS Metrics  │ │ Feedback    │ │
            │                │ │ Loop        │ │
            │ • Faithfulness │ │             │ │
            │   (> 0.85)     │ │ • 👍/👎    │ │
            │ • Answer Rel.  │ │ • Salva     │ │
            │   (> 0.80)     │ │ • Re-treina │ │
            │ • Context Prec.│ │   a cada    │ │
            │   (> 0.75)     │ │   100       │ │
            │ • Context Rec. │ │   feedbacks │ │
            │   (> 0.80)     │ │             │ │
            └────────┬───────┘ └──┬──────────┘ │
                     │            │            │
                     └────────┬───┘            │
                              │               │
                    ┌─────────▼────────┐      │
                    │ Dashboard        │      │
                    │ (Grafana)        │      │
                    │                  │      │
                    │ • Gráficos       │      │
                    │ • Alertas        │      │
                    │ • Relatórios     │      │
                    └──────────────────┘      │
                                             │
                    ┌────────────────────────┘
                    │
                    ▼
            ┌──────────────────┐
            │ Melhoria Contínua│
            │ (Feedback Loop)  │
            └──────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                        STACK TECNOLÓGICO COMPLETO                           │
└─────────────────────────────────────────────────────────────────────────────┘


    FRONTEND                    BACKEND                    INFRAESTRUTURA
    ────────                    ───────                    ──────────────

    React                       Hono                       PostgreSQL
    TypeScript                  Go (Gin)                   + pgvector
    TipTap Editor               Node.js                    + tsvector
    Socket.io-client            Socket.io                  
    Yjs (CRDT)                  Redis                      Chroma
    TailwindCSS                 BullMQ                     (Vector DB)
    Zustand                     Gemini API                 
    Edge AI                     Cohere Rerank              Docker
    (Gemini Nano)               RAGAS                      Compose
                                                           
                                                           Grafana
                                                           Prometheus


┌─────────────────────────────────────────────────────────────────────────────┐
│                        FLUXO DE DADOS COMPLETO                              │
└─────────────────────────────────────────────────────────────────────────────┘


    1. USUÁRIO DIGITA
       └─> Editor (TipTap)
           └─> WebSocket emit "document-update"

    2. BACKEND RECEBE
       └─> RealtimeRAGService
           └─> scheduleIndexing() [PONTO 1]
               └─> Debounce 30s
                   └─> Semantic Diff
                       └─> Se mudou, indexa em Chroma

    3. USUÁRIO PERGUNTA
       └─> Socket emit "rag-query"
           └─> handleRAGQuery()
               └─> detectPromptInjection() [PONTO 3]
                   └─> hybridSearch() [PONTO 2]
                       ├─> vectorSearch (Chroma)
                       ├─> keywordSearch (PostgreSQL)
                       └─> reciprocalRankFusion()
                           └─> generateResponse()
                               └─> validateOutput() [PONTO 3]
                                   ├─> sanitizePII()
                                   └─> detectHallucination()
                                       └─> logQuery()
                                           └─> evaluateRAGAS() [PONTO 5]

    4. RESPOSTA RETORNA
       └─> Frontend recebe
           └─> Exibe com feedback buttons
               └─> Usuário clica 👍/👎
                   └─> Feedback salvo
                       └─> A cada 100, re-treina


┌─────────────────────────────────────────────────────────────────────────────┐
│                        MÉTRICAS DE PERFORMANCE                              │
└─────────────────────────────────────────────────────────────────────────────┘


    INDEXAÇÃO (PONTO 1)
    ├─ Debounce: 30s
    ├─ Semantic Diff: < 10ms
    ├─ Economia: 70-80%
    └─ Cache Hit Rate: > 80%

    BUSCA (PONTO 2)
    ├─ Vector Search: < 100ms
    ├─ Keyword Search: < 50ms
    ├─ RRF Fusion: < 10ms
    ├─ Total Retrieval: < 200ms
    └─ Relevância: +25-40%

    SEGURANÇA (PONTO 3)
    ├─ Injection Detection: < 5ms
    ├─ PII Redaction: < 10ms
    ├─ Hallucination Check: < 20ms
    ├─ Taxa de Bloqueio: 99%
    └─ False Positives: < 1%

    EDGE AI (PONTO 4)
    ├─ Autocomplete Local: < 100ms
    ├─ Fallback Latency: 500ms
    ├─ API Calls Saved: 80%
    └─ Offline Support: ✅

    LLMOPS (PONTO 5)
    ├─ RAGAS Evaluation: < 5min
    ├─ Faithfulness: > 0.85
    ├─ Answer Relevance: > 0.80
    ├─ Context Precision: > 0.75
    └─ Context Recall: > 0.80


╔════════════════════════════════════════════════════════════════════════════════╗
║                                                                                ║
║                    ✅ ARQUITETURA PRONTA PARA PRODUÇÃO                        ║
║                                                                                ║
║              Implementação: 5 semanas | Impacto: Altíssimo                    ║
║                                                                                ║
╚════════════════════════════════════════════════════════════════════════════════╝
